[supervisord]
nodaemon=true
user=app
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
loglevel=info
silent=false

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700
chown=app:app

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[program:flask-api]
command=python app/main.py
directory=/app
user=app
autostart=true
autorestart=true
startretries=3
redirect_stderr=true
stdout_logfile=/var/log/supervisor/flask-api.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile=/var/log/supervisor/flask-api-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
environment=FLASK_HOST="%(ENV_FLASK_HOST)s",FLASK_PORT="%(ENV_FLASK_PORT)s",FLASK_DEBUG="%(ENV_FLASK_DEBUG)s"
stopwaitsecs=10
killasgroup=true
stopasgroup=true

[program:streamlit-dashboard]
command=streamlit run app/dashboard.py --server.port=%(ENV_STREAMLIT_PORT)s --server.address=%(ENV_STREAMLIT_HOST)s --server.headless=true --browser.serverAddress=%(ENV_STREAMLIT_HOST)s --browser.gatherUsageStats=false
directory=/app
user=app
autostart=true
autorestart=true
startretries=3
redirect_stderr=true
stdout_logfile=/var/log/supervisor/streamlit.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile=/var/log/supervisor/streamlit-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
environment=API_URL="%(ENV_API_URL)s"
stopwaitsecs=10
killasgroup=true
stopasgroup=true

[group:auto-feedback]
programs=flask-api,streamlit-dashboard
priority=999

[eventlistener:stdout]
command=supervisor_stdout
buffer_size=100
events=PROCESS_LOG
result_handler=supervisor_stdout:event_handler
